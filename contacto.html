<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro con Login - Strat & Tax</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* 游꿛 VARIABLES DE ESTILO GLOBAL */

        :root {
            --bg: #9c9c9cce;
            /* Gris Claro */
            --accent: #323c47;
            /* Azul navy */
            --accent-light: #565758;
            /* Azul navy m치s claro */
            --muted: #515457;
            /* Gris medio */
            --panel: #bbbbbb;
            /* Blanco para paneles/formularios */
            --border: #70859a;
            /* Gris claro para bordes */
            --shadow: 0 4px 12px rgba(71, 82, 199, 0.1);
            /* Sombra sutil */
            --radius: 8px;
            /* Bordes redondeados */
            --font-main: "Inter", system-ui, sans-serif;
            --color-secondary: #D4AF37;
            /* Dorado */
        }

        /* 游눹 ESTILOS GENERALES Y DEL HEADER/FOOTER */
        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--accent);
            font-family: var(--font-main);
            line-height: 1.6;
        }

        header {
            background: var(--accent);
            color: #001f3fb3;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            height: 100px;
            width: auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 600;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 10;
            padding: 0;
        }

        nav a {
            color: #ffffff75;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        nav a:hover {
            color: var(--color-secondary);
        }

        footer {
            background: var(--accent);
            color: #c4c1c1;
            text-align: center;
            padding: 20px;
        }

        /* 游닇 ESTILOS DE CONTENIDO Y FORMULARIOS */
        .page-content {
            padding: 60px 20px;
            /* Incrementado para m치s espacio vertical */
            min-height: calc(100vh - 140px);
            /* Ajuste para que el footer quede abajo */
        }

        .card {
            background: var(--panel);
            /* Usar panel */
            padding: 90px;
            /* Padding interior est치ndar de panel/tarjeta */
            /* Se eliminan los anchos no funcionales (width: 200%) y se restablece el max-width */
            width: 100%;
            /* Ajuste de ancho: 90% del contenedor */
            max-width: 450px;
            /* M치ximo ancho t칤pico para formularios centrados */
            margin: 0 auto;
            /* Centrar el contenedor horizontalmente */
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            /* Usar sombra */
            margin-bottom: 40px;
        }

        h1 {
            color: var(--accent);
            /* Color coherente */
            text-align: center;
            margin-top: 0;
            font-size: 2.5rem;
            border-bottom: 3px solid var(--color-secondary);
            /* Raya dorada */
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--accent);
            font-weight: 60;
            font-size: 1.8rem;
            text-align: center;
        }

        /* Estilo para los enlaces de navegaci칩n dentro del contenido */
        .page-nav a {
            margin-right: 15px;
            text-decoration: none;
            font-weight: bold;
            color: var(--accent-light);
            /* Color coherente */
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            /* Ajuste de padding */
            border-radius: 10px;
            border: 1px solid var(--border);
            box-sizing: border-box;
            font-size: 1rem;
            color: var(--accent);
            background: #cdcece;
            /* Fondo gris claro para campos */
            margin-top: 10px;
            margin-bottom: 10px;
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--accent);
            margin-top: 15px;
        }

        button {
            padding: 16px;
            /* Ajuste de padding */
            width: 100%;
            background: var(--accent);
            /* Azul navy para bot칩n de acci칩n */
            color: #e1dfdf;
            border: none;
            border-radius: var(--radius);
            margin-top: 20px;
            /* M치s espacio */
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--accent-light);
        }

        #logout-btn {
            background: #982626;
            /* Rojo para logout */
            width: 200px;
            margin-top: 20px;
            margin-left: auto;
            margin-right: auto;
            display: none;
            /* Oculto por defecto */
        }

        #logout-btn:hover {
            background: #a12020;
        }

        /* Control de visibilidad para la funcionalidad de login */
        #form-solicitud,
        #logout-btn {
            display: none;
            /* Ocultar formulario de solicitud y bot칩n de logout por defecto */
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo-container">
                <img src="stratandtax.png" alt="Logo Strat & Tax" class="logo-img">
                <div class="logo"></div>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="#">Registro con Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="page-content">
        <h1>游댏 Acceso a registro</h1>

        <div style="text-align:center;" class="page-nav">
            <a href="index.html">Inicio</a>
            <a href="contacto.html">Registro</a>
        </div>

        <div id="login-card" class="card">
            <h2>Iniciar Sesi칩n</h2>
            <label for="usuario">Usuario:</label>
            <input type="text" id="usuario" placeholder="Ingresa tu usuario">

            <label for="password">Contrase침a:</label>
            <input type="password" id="password" placeholder="Ingresa tu contrase침a">

            <button onclick="login()">Entrar</button>
            <p style="color:red; display:none; margin-top:15px; text-align: center;" id="error-msg">
                Usuario o contrase침a incorrectos.
            </p>
        </div>
        <div id="form-solicitud" class="card">
            <h2>Generar registro.</h2>
            <p style="text-align:center;"></p>
            <div id="response-message" class="message" style="display: none;"></div>

            <form id="solicitudForm" enctype="multipart/form-data">

                <div class="form-group">
                    <label for="servicio">Selecciona un servicio (*)</label>
                    <select id="servicio" name="servicio" required>
                        <option value="" disabled selected>--- Elige una opci칩n ---</option>
                        <option value="Servicios de construccion de unidades unifamiliares">Servicios de construccion de
                            unidades unifamiliares</option>
                        <option value="Servicios de reparacion o ampliacion o remodelacion de viviendas unifamiliares">
                            Servicios de reparacion o ampliacion o remodelacion de viviendas unifamiliares</option>
                        <option value="Servicio de remodelacion general de viviendas unifamiliares">Servicio de
                            remodelacion general de viviendas unifamiliares</option>
                        <option value="Servicios de reparacion de casas moviles en el sitio">Servicios de reparacion de
                            casas moviles en el sitio</option>
                        <option value="Servicios de construccion y reparacion de patios y terrazas">Servicios de
                            construccion y reparacion de patios y terrazas</option>
                        <option value="Servico de reparacion por da침os ocasionados por fuego de viviendas unifamiliares">
                            Servico de reparacion por da침os ocasionados por fuego de viviendas unifamiliares</option>
                        <option value="Servicio de construccion de casas unifamiliares nuevas">Servicio de construccion
                            de casas unifamiliares nuevas</option>
                        <option value="Servicio de instalacion de casas unifamiliares prefabricadas">Servicio de
                            instalacion de casas unifamiliares prefabricadas</option>
                        <option value="Servicio de construccion de casas en la ciudad o casas jardin unifamiliares nuevas">
                            Servicio de construccion de casas en la ciudad o casas jardin unifamiliares nuevas</option>
                        <option value="Dasarrollo urbano">Desarrollo urbano</option>
                        <option value="Servicio de planificacion de la ordenacion urbana">Servicio de planificacion de
                            la ordenacion urbana</option>
                        <option value="Servicio de administracion de tierras urbanas">Servicio de administracion de
                            tierras urbanas</option>
                        <option value="Servicio de programacion de inversiones urbanas">Servicio de programacion de
                            inversiones urbanas</option>
                        <option value="Servicio de reestructuracion de barrios marginales">Servicio de reestructuracion
                            de barrios marginales</option>
                        <option value="Servicios de alumbrado urbano">Servicios de alumbrado urbano</option>
                        <option value="Servicios de control o regulacion del desarrollo urbano">Servicios de control o
                            regulacion del desarrollo urbano</option>
                        <option value="Servicios de estandares o regulacion de edificios urbanos">Servicios de estandares
                            o regulacion de edificios urbanos</option>
                        <option value="Servicios comunitarios urbanos">Servicios comunitarios urbanos</option>
                        <option value="Servicios de administracion o gestion de proyectos o programas urbanos">Servicios de
                            administracion o gestion de proyectos o programas urbanos</option>
                        <option value="Ingenieria civil">Ingenieria civil</option>
                        <option value="Ingenieria de carreteras">Ingenieria de carreteras</option>
                        <option value="Ingenieria deinfraestructura de instalaciones o fabricas">Ingenieria deinfraestructura
                            de instalaciones o fabricas</option>
                        <option value="Servicios de mantenimiento e instalacion de equipo pesado">Servicios de
                            mantenimiento e instalacion de equipo pesado</option>
                        <option value="Servicio de mantenimiento y reparacion de equipo pesado">Servicio de
                            mantenimiento y reparacion de equipo pesado</option>
                    </select>
                    <input type="hidden" id="descripcion_del_servicio" name="descripcion_del_servicio">
                </div>
                <div class="form-group">
                    <label for="razon_social">Raz칩n Social (*)</label>
                    <input type="text" id="razon_social" name="razon_social" required>
                </div>
                <div class="form-group">
                    <label for="r_f_c">R.F.C (*)</label>
                    <input type="text" id="r_f_c" name="r_f_c" required>
                </div>
                <div class="form-group">
                    <label for="domicilio_del_cliente">Domicilio del Cliente</label>
                    <input type="text" id="domicilio_del_cliente" name="domicilio_del_cliente">
                </div>
                <div class="form-group">
                    <label for="telefono_del_cliente">Tel칠fono del Cliente</label>
                    <input type="tel" id="telefono_del_cliente" name="telefono_del_cliente">
                </div>
                <div class="form-group">
                    <label for="correo_del_cliente">Correo del Cliente (*)</label>
                    <input type="email" id="correo_del_cliente" name="correo_del_cliente" required>
                </div>
                <div class="form-group">
                    <label for="fecha_de_operacion">Fecha de Operacion</label>
                    <input type="date" id="fecha_de_operacion" name="fecha_de_operacion">
                </div>
                <div class="form-group">
                    <label for="fecha_de_inicio_del_servicio">Fecha de Inicio Estimada</label>
                    <input type="date" id="fecha_de_inicio_del_servicio" name="fecha_de_inicio_del_servicio">
                </div>
                <div class="form-group">
                    <label for="fecha_de_conclusion_del_servicio">Fecha de Conclusi칩n Estimada</label>
                    <input type="date" id="fecha_de_conclusion_del_servicio" name="fecha_de_conclusion_del_servicio">
                </div>
                <div class="form-group">
                    <label for="monto_de_la_operacion_sin_iva">Monto de la Operaci칩n (Sin IVA) (*)</label>
                    <input type="number" id="monto_de_la_operacion_sin_iva" name="monto_de_la_operacion_sin_iva"
                        step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="forma_de_pago">Forma de Pago</label>
                    <input type="text" id="forma_de_pago" name="forma_de_pago">
                </div>
                <div class="form-group">
                    <label for="cantidad">Cantidad de Unidades</label>
                    <input type="number" id="cantidad" name="cantidad" step="1">
                </div>
                <div class="form-group">
                    <label for="numero_de_contrato">N칰mero de Contrato</label>
                    <input type="text" id="numero_de_contrato" name="numero_de_contrato">
                </div>
                <div class="form-group">
                    <label for="unidad">Unidad de Medida (Ej: Servicio, Hora, Documento)</label>
                    <input type="text" id="unidad" name="unidad">
                </div>
                <div class="form-group">
                    <label for="factura_relacionada_con_la_operacion">Factura Relacionada con la Operaci칩n</label>
                    <input type="text" id="factura_relacionada_con_la_operacion"
                        name="factura_relacionada_con_la_operacion">
                </div>
                <div class="form-group">
                    <label for="nombre_completo_de_la_persona_que_firma_la_solicitud">Nombre Completo de la Persona que
                        Firma (*)</label>
                    <input type="text" id="nombre_completo_de_la_persona_que_firma_la_solicitud"
                        name="nombre_completo_de_la_persona_que_firma_la_solicitud" required>
                </div>
                <div class="form-group">
                    <label for="cargo_de_la_persona_que_firma_la_solicitud">Cargo de la Persona que Firma</label>
                    <input type="text" id="cargo_de_la_persona_que_firma_la_solicitud"
                        name="cargo_de_la_persona_que_firma_la_solicitud">
                </div>
                <div class="form-group">
                    <label for="informe_si_cuenta_con_fotografias_videos_o_informacion_adicion">쮺uenta con fotograf칤as,
                        videos o informaci칩n adicional? (Describa)</label>
                    <textarea id="informe_si_cuenta_con_fotografias_videos_o_informacion_adicion"
                        name="informe_si_cuenta_con_fotografias_videos_o_informacion_adicion" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="comentarios">Comentarios Finales (Observaciones, notas)</label>
                    <textarea id="comentarios" name="comentarios" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="imagen_usuario">Cargar imagen para insertar en Word</label>
                    <input type="file" id="imagen_usuario" name="imagen_usuario" accept="image/*">
                </div>

                <button type="submit" class="btn-submit">Generar Solicitud y Descargar Word</button>

            </form>
        </div>
        <button id="logout-btn" onclick="logout()">
            Cerrar sesi칩n
        </button>
    </div>

    <footer>
        &copy; 2025 Strat & Tax. Todos los derechos reservados.
    </footer>

<script type="module">
    /* ===========================
        IMPORTS AMPLIFY
        =========================== */
    // Aseg칰rate de importar 'Auth' para el inicio de sesi칩n con Cognito.
    import { Amplify, API, Auth } from "https://cdn.jsdelivr.net/npm/aws-amplify/+esm";


    /* ===========================
        ELEMENTOS DEL DOM
        =========================== */
    const loginCard = document.getElementById("login-card");
    const formSolicitud = document.getElementById("form-solicitud");
    const logoutBtn = document.getElementById("logout-btn");
    const errorMsg = document.getElementById("error-msg");
    const usuarioInput = document.getElementById("usuario");
    const passwordInput = document.getElementById("password");

    const form = document.getElementById("solicitudForm");
    const responseMessage = document.getElementById("response-message");
    const submitButton = document.querySelector(".btn-submit");
    const servicioSelect = document.getElementById("servicio");
    const descHiddenInput = document.getElementById("descripcion_del_servicio");


    /* ===========================
        CONFIGURACI칍N DE AMPLIFY
        =========================== */
    Amplify.configure({
        Auth: {
            region: "us-east-2",
            userPoolId: "us-east-2_sWJSQ4mrD",
            // IMPORTANTE: El userPoolWebClientId debe ser el ID de tu cliente de la aplicaci칩n, NO el ARN.
            // Lo he corregido asumiendo que el ARN es un error tipogr치fico y el ID es necesario.
            // Si el ARN us-east-2:165046688056:userpool/us-east-2_sWJSQ4mrD es tu Client ID, d칠jalo. 
            // Si no, debes usar solo el Client ID (ej: 1234abcd5678efgh90ijklmn). Por ahora, lo dejo como estaba en tu script original.
            userPoolWebClientId: "arn:aws:cognito-idp:us-east-2:165046688056:userpool/us-east-2_sWJSQ4mrD",
            mandatorySignIn: true
        },
        API: {
            endpoints: [
                {
                    name: "stratantax_f_p_y-API-genword",
                    endpoint: "https://vj3leje6ee.execute-api.us-east-2.amazonaws.com/prod",
                    region: "us-east-2"
                }
            ]
        }
    });


    /* ===========================
        ENDPOINTS LOCALES
        =========================== */
    // NOTA: Estos endpoints ya no son necesarios para el login si usas Auth de Amplify.
    const API_BASE_URL = "https://main.drh93y5i2fkgi.amplifyapp.com/contacto.html";
    const PYTHON_ENDPOINT = `${API_BASE_URL}/generate-word`;
    const LOGIN_ENDPOINT = `${API_BASE_URL}/login`; // Mantengo la l칤nea para respetar la estructura, pero no se usar치 en el login.


    /* ===========================
        CONTROL DE INTERFAZ
        =========================== */
    function displayUI(isLoggedIn) {
        loginCard.style.display = isLoggedIn ? "none" : "block";
        formSolicitud.style.display = isLoggedIn ? "block" : "none";
        logoutBtn.style.display = isLoggedIn ? "block" : "none";
        errorMsg.style.display = "none";

        if (!isLoggedIn) {
            usuarioInput.value = "";
            passwordInput.value = "";
        }
    }

    async function checkLoginState() {
        // Usar Auth.currentSession() para verificar el estado de Cognito.
        try {
            await Auth.currentSession();
            // Si no hay error, el usuario est치 logueado.
            displayUI(true);
        } catch (error) {
            // Si hay un error (ej: no hay sesi칩n), el usuario no est치 logueado.
            console.log("No hay sesi칩n activa de Cognito.");
            displayUI(false);
        }
    }


    /* ===========================
        API PROTEGIDA (AMPLIFY)
        =========================== */
    async function llamarApiProtegida() {
        try {
            // Para una API de AWS protegida por Cognito, el objeto de configuraci칩n del request (el tercer par치metro)
            // normalmente incluye una propiedad 'headers' con un 'Authorization' para usar la sesi칩n actual.
            // Amplify maneja esto autom치ticamente si el backend es una API Gateway configurada con Cognito Authorizer,
            // pero siempre es bueno saber que las credenciales van con el request.
            const response = await API.get(
                "stratantax_f_p_y-API-genword",
                "/ruta-del-recurso",
                {} // Amplify inyecta el token autom치ticamente si Auth est치 configurado correctamente.
            );
            console.log("Respuesta API Cognito:", response);
        } catch (error) {
            console.error("Error al llamar API protegida:", error);
        }
    }


    /* ===========================
        LOGIN (MODIFICADO PARA USAR AUTH DE AMPLIFY)
        =========================== */
    async function login() {
        const username = usuarioInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !password) {
            // COMENTARIO DE NOTIFICACI칍N: Se muestran los campos que faltan por completar.
            errorMsg.innerText = "Completa todos los campos para iniciar sesi칩n.";
            errorMsg.style.display = "block";
            return;
        }

        try {
            // *** CAMBIO CLAVE: Usamos Auth.signIn de Amplify para interactuar con Cognito ***
            const user = await Auth.signIn(username, password);

            // Una vez logueado, obtenemos la sesi칩n para poder obtener el token JWT
            const session = await Auth.currentSession();
            
            // Guardamos el token de ID o de Acceso para usarlo en llamadas a APIs que no son de Amplify
            // Se usa el ID Token porque es el que contiene la informaci칩n del usuario.
            const token = session.getIdToken().getJwtToken();
            
            // NOTA: Con Auth de Amplify, no es estrictamente necesario guardar el token en localStorage
            // si solo usas el m칩dulo API de Amplify (que lo inyecta autom치ticamente).
            // Lo mantengo aqu칤 para respetar la l칩gica de tu formulario posterior (env칤o a PYTHON_ENDPOINT).
            localStorage.setItem("jwtToken", token);
            localStorage.setItem("isLoggedIn", "true");
            
            displayUI(true);
            
            // Opcional: Llamar a la API protegida inmediatamente despu칠s del login exitoso
            // llamarApiProtegida(); 

        } catch (err) {
            let errorMessage = "Error de conexi칩n o credenciales inv치lidas.";
            
            // COMENTARIO DE NOTIFICACI칍N: Se eval칰a el tipo de error para dar un mensaje espec칤fico.
            if (err.code === "UserNotFoundException") {
                errorMessage = "No se puede acceder: Usuario no encontrado en Cognito.";
            } else if (err.code === "NotAuthorizedException") {
                errorMessage = "No se puede acceder: Contrase침a incorrecta para este usuario.";
            } else if (err.code === "UserNotConfirmedException") {
                errorMessage = "No se puede acceder: El usuario debe ser confirmado antes de iniciar sesi칩n.";
            } else {
                console.error("Error detallado de Cognito:", err);
            }

            errorMsg.innerText = errorMessage;
            errorMsg.style.display = "block";
        }
    }

    // Event listener para el login
    loginCard.addEventListener("submit", (e) => {
        e.preventDefault();
        login();
    });


    /* ===========================
        LOGOUT
        =========================== */
    async function logout() {
        try {
            // *** CAMBIO CLAVE: Usamos Auth.signOut de Amplify para cerrar la sesi칩n de Cognito ***
            await Auth.signOut();
            console.log("Sesi칩n de Cognito cerrada.");
        } catch (error) {
            console.error("Error al cerrar sesi칩n de Cognito:", error);
        }
        
        // Limpiamos el almacenamiento local y actualizamos la interfaz
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("jwtToken");
        displayUI(false);
    }
    
    // Event listener para el logout
    logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        logout();
    });


    /* ===========================
        FORMULARIO PARA BACKEND PYTHON
        =========================== */
    servicioSelect.addEventListener("change", () => {
        descHiddenInput.value = servicioSelect.value;
    });

    function showMessage(text, type) {
        responseMessage.textContent = text;
        responseMessage.className = `message ${type}`;
        responseMessage.style.display = "block";
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        responseMessage.style.display = "none";

        submitButton.disabled = true;
        submitButton.textContent = "Procesando...";

        try {
            const formData = new FormData(form);
            const token = localStorage.getItem("jwtToken");

            if (!token) {
                // COMENTARIO DE NOTIFICACI칍N: Muestra el motivo por el cual no se env칤a.
                showMessage("No se puede enviar la solicitud: Token expirado o no existe. Inicia sesi칩n.", "error");
                logout();
                return;
            }

            const response = await fetch(PYTHON_ENDPOINT, {
                method: "POST",
                // Se respeta el env칤o del token JWT en el header de Autorizaci칩n
                headers: { Authorization: `Bearer ${token}` },
                body: formData
            });

            if (response.ok) {
                const blob = await response.blob();
                const contentDisposition = response.headers.get("Content-Disposition");
                let filename = "Documentos_Generados.zip";

                if (contentDisposition && contentDisposition.includes("filename=")) {
                    filename = contentDisposition.match(/filename="(.+?)"/)[1];
                }

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);

                showMessage(`Documento descargado: ${filename}`, "success");

            } else {
                const errorData = await response.json().catch(() => ({}));
                // COMENTARIO DE NOTIFICACI칍N: Muestra el error espec칤fico de la API Python.
                showMessage(errorData.error || "Error en la API Python al procesar solicitud.", "error");
            }

        } catch (error) {
            console.error("Error enviando formulario:", error);
            // COMENTARIO DE NOTIFICACI칍N: Muestra el problema de conexi칩n con el servidor.
            showMessage("No se pudo contactar al servidor Python. Verifica la URL del endpoint.", "error");
        }

        submitButton.disabled = false;
        submitButton.textContent = "Generar Solicitud y Descargar Word";
    });


    /* ===========================
        ESTADO INICIAL
        =========================== */
    checkLoginState();
</script>

</body>

</html>
