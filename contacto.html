<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro con Login - Strat & Tax</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /*  VARIABLES DE ESTILO GLOBAL */

        :root {
            --bg: #9c9c9cce;
            /* Gris Claro */
            --accent: #323c47;
            /* Azul navy */
            --accent-light: #565758;
            /* Azul navy m谩s claro */
            --muted: #515457;
            /* Gris medio */
            --panel: #bbbbbb;
            /* Blanco para paneles/formularios */
            --border: #70859a;
            /* Gris claro para bordes */
            --shadow: 0 4px 12px rgba(71, 82, 199, 0.1);
            /* Sombra sutil */
            --radius: 8px;
            /* Bordes redondeados */
            --font-main: "Inter", system-ui, sans-serif;
            --color-secondary: #D4AF37;
            /* Dorado */
        }

        /*  ESTILOS GENERALES Y DEL HEADER/FOOTER */
        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--accent);
            font-family: var(--font-main);
            line-height: 1.6;
        }

        header {
            background: var(--accent);
            color: #001f3fb3;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            height: 100px;
            width: auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 600;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 10;
            padding: 0;
        }

        nav a {
            color: #ffffff75;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        nav a:hover {
            color: var(--color-secondary);
        }

        footer {
            background: var(--accent);
            color: #c4c1c1;
            text-align: center;
            padding: 20px;
        }

        /*  ESTILOS DE CONTENIDO Y FORMULARIOS */
        .page-content {
            padding: 60px 20px;
            /* Incrementado para m谩s espacio vertical */
            min-height: calc(100vh - 140px);
            /* Ajuste para que el footer quede abajo */
        }

        .card {
            background: var(--panel);
            /* Usar panel */
            padding: 90px;
            /* Padding interior est谩ndar de panel/tarjeta */
            /* Se eliminan los anchos no funcionales (width: 200%) y se restablece el max-width */
            width: 100%;
            /* Ajuste de ancho: 90% del contenedor */
            max-width: 450px;
            /* M谩ximo ancho t铆pico para formularios centrados */
            margin: 0 auto;
            /* Centrar el contenedor horizontalmente */
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            /* Usar sombra */
            margin-bottom: 40px;
        }

        h1 {
            color: var(--accent);
            /* Color coherente */
            text-align: center;
            margin-top: 0;
            font-size: 2.5rem;
            border-bottom: 3px solid var(--color-secondary);
            /* Raya dorada */
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: var(--accent);
            font-weight: 60;
            font-size: 1.8rem;
            text-align: center;
        }

        /* Estilo para los enlaces de navegaci贸n dentro del contenido */
        .page-nav a {
            margin-right: 15px;
            text-decoration: none;
            font-weight: bold;
            color: var(--accent-light);
            /* Color coherente */
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            /* Ajuste de padding */
            border-radius: 10px;
            border: 1px solid var(--border);
            box-sizing: border-box;
            font-size: 1rem;
            color: var(--accent);
            background: #cdcece;
            /* Fondo gris claro para campos */
            margin-top: 10px;
            margin-bottom: 10px;
        }

        label {
            display: block;
            font-weight: 600;
            color: var(--accent);
            margin-top: 15px;
        }

        button {
            padding: 16px;
            /* Ajuste de padding */
            width: 100%;
            background: var(--accent);
            /* Azul navy para bot贸n de acci贸n */
            color: #e1dfdf;
            border: none;
            border-radius: var(--radius);
            margin-top: 20px;
            /* M谩s espacio */
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--accent-light);
        }

        #logout-btn {
            background: #982626;
            /* Rojo para logout */
            width: 200px;
            margin-top: 20px;
            margin-left: auto;
            margin-right: auto;
            display: none;
            /* Oculto por defecto */
        }

        #logout-btn:hover {
            background: #a12020;
        }

        /* Control de visibilidad para la funcionalidad de login */
        #form-solicitud,
        #logout-btn {
            display: none;
            /* Ocultar formulario de solicitud y bot贸n de logout por defecto */
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo-container">
                <img src="stratandtax.png" alt="Logo Strat & Tax" class="logo-img">
                <div class="logo"></div>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="#">Registro con Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="page-content">
        <h1> Acceso a registro</h1>

        <div style="text-align:center;" class="page-nav">
            <a href="index.html">Inicio</a>
            <a href="contacto.html">Registro</a>
        </div>

        <div id="login-card" class="card">
            <h2>Iniciar Sesi贸n</h2>
            <label for="usuario">Usuario:</label>
            <input type="text" id="usuario" placeholder="Ingresa tu usuario">

            <label for="password">Contrase帽a:</label>
            <input type="password" id="password" placeholder="Ingresa tu contrase帽a">

            <button onclick="login()">Entrar</button>
            <p style="color:red; display:none; margin-top:15px; text-align: center;" id="error-msg">
                Usuario o contrase帽a incorrectos.
            </p>
        </div>
        <div id="form-solicitud" class="card">
            <h2>Generar registro.</h2>
            <p style="text-align:center;"></p>
            <div id="response-message" class="message" style="display: none;"></div>

            <form id="solicitudForm" enctype="multipart/form-data">

                <div class="form-group">
                    <label for="servicio">Selecciona un servicio (*)</label>
                    <select id="servicio" name="servicio" required>
                        <option value="" disabled selected>--- Elige una opci贸n ---</option>
                        <option value="Servicios de construccion de unidades unifamiliares">Servicios de construccion de
                            unidades unifamiliares</option>
                        <option value="Servicios de reparacion o ampliacion o remodelacion de viviendas unifamiliares">
                            Servicios de reparacion o ampliacion o remodelacion de viviendas unifamiliares</option>
                        <option value="Servicio de remodelacion general de viviendas unifamiliares">Servicio de
                            remodelacion general de viviendas unifamiliares</option>
                        <option value="Servicios de reparacion de casas moviles en el sitio">Servicios de reparacion de
                            casas moviles en el sitio</option>
                        <option value="Servicios de construccion y reparacion de patios y terrazas">Servicios de
                            construccion y reparacion de patios y terrazas</option>
                        <option value="Servico de reparacion por da帽os ocasionados por fuego de viviendas unifamiliares">
                            Servico de reparacion por da帽os ocasionados por fuego de viviendas unifamiliares</option>
                        <option value="Servicio de construccion de casas unifamiliares nuevas">Servicio de construccion
                            de casas unifamiliares nuevas</option>
                        <option value="Servicio de instalacion de casas unifamiliares prefabricadas">Servicio de
                            instalacion de casas unifamiliares prefabricadas</option>
                        <option value="Servicio de construccion de casas en la ciudad o casas jardin unifamiliares nuevas">
                            Servicio de construccion de casas en la ciudad o casas jardin unifamiliares nuevas</option>
                        <option value="Dasarrollo urbano">Desarrollo urbano</option>
                        <option value="Servicio de planificacion de la ordenacion urbana">Servicio de planificacion de
                            la ordenacion urbana</option>
                        <option value="Servicio de administracion de tierras urbanas">Servicio de administracion de
                            tierras urbanas</option>
                        <option value="Servicio de programacion de inversiones urbanas">Servicio de programacion de
                            inversiones urbanas</option>
                        <option value="Servicio de reestructuracion de barrios marginales">Servicio de reestructuracion
                            de barrios marginales</option>
                        <option value="Servicios de alumbrado urbano">Servicios de alumbrado urbano</option>
                        <option value="Servicios de control o regulacion del desarrollo urbano">Servicios de control o
                            regulacion del desarrollo urbano</option>
                        <option value="Servicios de estandares o regulacion de edificios urbanos">Servicios de estandares
                            o regulacion de edificios urbanos</option>
                        <option value="Servicios comunitarios urbanos">Servicios comunitarios urbanos</option>
                        <option value="Servicios de administracion o gestion de proyectos o programas urbanos">Servicios de
                            administracion o gestion de proyectos o programas urbanos</option>
                        <option value="Ingenieria civil">Ingenieria civil</option>
                        <option value="Ingenieria de carreteras">Ingenieria de carreteras</option>
                        <option value="Ingenieria deinfraestructura de instalaciones o fabricas">Ingenieria deinfraestructura
                            de instalaciones o fabricas</option>
                        <option value="Servicios de mantenimiento e instalacion de equipo pesado">Servicios de
                            mantenimiento e instalacion de equipo pesado</option>
                        <option value="Servicio de mantenimiento y reparacion de equipo pesado">Servicio de
                            mantenimiento y reparacion de equipo pesado</option>
                    </select>
                    <input type="hidden" id="descripcion_del_servicio" name="descripcion_del_servicio">
                </div>
                <div class="form-group">
                    <label for="razon_social">Raz贸n Social (*)</label>
                    <input type="text" id="razon_social" name="razon_social" required>
                </div>
                <div class="form-group">
                    <label for="r_f_c">R.F.C (*)</label>
                    <input type="text" id="r_f_c" name="r_f_c" required>
                </div>
                <div class="form-group">
                    <label for="domicilio_del_cliente">Domicilio del Cliente</label>
                    <input type="text" id="domicilio_del_cliente" name="domicilio_del_cliente">
                </div>
                <div class="form-group">
                    <label for="telefono_del_cliente">Tel茅fono del Cliente</label>
                    <input type="tel" id="telefono_del_cliente" name="telefono_del_cliente">
                </div>
                <div class="form-group">
                    <label for="correo_del_cliente">Correo del Cliente (*)</label>
                    <input type="email" id="correo_del_cliente" name="correo_del_cliente" required>
                </div>
                <div class="form-group">
                    <label for="fecha_de_operacion">Fecha de Operaci贸n</label>
                    <input type="date" id="fecha_de_operacion" name="fecha_de_operacion">
                </div>
                <div class="form-group">
                    <label for="fecha_de_inicio_del_servicio">Fecha de Inicio Estimada</label>
                    <input type="date" id="fecha_de_inicio_del_servicio" name="fecha_de_inicio_del_servicio">
                </div>
                <div class="form-group">
                    <label for="fecha_de_conclusion_del_servicio">Fecha de Conclusi贸n Estimada</label>
                    <input type="date" id="fecha_de_conclusion_del_servicio" name="fecha_de_conclusion_del_servicio">
                </div>
                <div class="form-group">
                    <label for="monto_de_la_operacion_sin_iva">Monto de la Operaci贸n (Sin IVA) (*)</label>
                    <input type="number" id="monto_de_la_operacion_sin_iva" name="monto_de_la_operacion_sin_iva"
                        step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="forma_de_pago">Forma de Pago</label>
                    <input type="text" id="forma_de_pago" name="forma_de_pago">
                </div>
                <div class="form-group">
                    <label for="cantidad">Cantidad de Unidades</label>
                    <input type="number" id="cantidad" name="cantidad" step="1">
                </div>
                <div class="form-group">
                    <label for="numero_de_contrato">N煤mero de Contrato</label>
                    <input type="text" id="numero_de_contrato" name="numero_de_contrato">
                </div>
                <div class="form-group">
                    <label for="unidad">Unidad de Medida (Ej: Servicio, Hora, Documento)</label>
                    <input type="text" id="unidad" name="unidad">
                </div>
                <div class="form-group">
                    <label for="factura_relacionada_con_la_operacion">Factura Relacionada con la Operaci贸n</label>
                    <input type="text" id="factura_relacionada_con_la_operacion"
                        name="factura_relacionada_con_la_operacion">
                </div>
                <div class="form-group">
                    <label for="nombre_completo_de_la_persona_que_firma_la_solicitud">Nombre Completo de la Persona que
                        Firma (*)</label>
                    <input type="text" id="nombre_completo_de_la_persona_que_firma_la_solicitud"
                        name="nombre_completo_de_la_persona_que_firma_la_solicitud" required>
                </div>
                <div class="form-group">
                    <label for="cargo_de_la_persona_que_firma_la_solicitud">Cargo de la Persona que Firma</label>
                    <input type="text" id="cargo_de_la_persona_que_firma_la_solicitud"
                        name="cargo_de_la_persona_que_firma_la_solicitud">
                </div>
                <div class="form-group">
                    <label for="informe_si_cuenta_con_fotografias_videos_o_informacion_adicion">驴Cuenta con fotograf铆as,
                        videos o informaci贸n adicional? (Describa)</label>
                    <textarea id="informe_si_cuenta_con_fotografias_videos_o_informacion_adicion"
                        name="informe_si_cuenta_con_fotografias_videos_o_informacion_adicion" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="comentarios">Comentarios Finales (Observaciones, notas)</label>
                    <textarea id="comentarios" name="comentarios" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="imagen_usuario">Cargar imagen para insertar en Word</label>
                    <input type="file" id="imagen_usuario" name="imagen_usuario" accept="image/*">
                </div>

                <button type="submit" class="btn-submit">Generar Solicitud y Descargar Word</button>

            </form>
        </div>
        <button id="logout-btn" onclick="logout()">
            Cerrar sesi贸n
        </button>
    </div>

    <footer>
        &copy; 2025 Strat & Tax. Todos los derechos reservados.
    </footer>

    <script>
        //  Credenciales Fijas (para el ejemplo de demostraci贸n - DEBE SER REEMPLAZADO POR UNA LLAMADA A SU BACKEND REAL)
        // const userDB = {
        //     username: "admin",
        //     password: "1234"
        // };

        const loginCard = document.getElementById("login-card");
        const formSolicitud = document.getElementById("form-solicitud");
        const logoutBtn = document.getElementById("logout-btn");
        const errorMsg = document.getElementById("error-msg");
        const usuarioInput = document.getElementById("usuario");
        const passwordInput = document.getElementById("password");

        // 锔 ADECUACIN CRTICA: Definir la URL base de su API Gateway / Load Balancer en AWS
        const API_BASE_URL = "https://main.dqrw8x5b2nh6g.amplifyapp.com/contacto.html"; 
        // Ejemplo para entorno de prueba:
        // const API_BASE_URL = "https://main.dqrw8x5b2nh6g.amplifyapp.com"; 

        /**
         * Controla la visibilidad de los elementos basados en si el usuario est谩 logueado.
         * @param {boolean} isLoggedIn - Estado de la sesi贸n.
         */
        function displayUI(isLoggedIn) {
            if (isLoggedIn) {
                // Si est谩 logueado: Ocultar login y mostrar formulario/logout
                loginCard.style.display = "none";
                formSolicitud.style.display = "block";
                logoutBtn.style.display = "block";
                document.getElementById('error-msg').style.display = "none"; // Asegurar que se oculta
            } else {
                // Si no est谩 logueado: Mostrar login y ocultar formulario/logout
                formSolicitud.style.display = "none";
                logoutBtn.style.display = "none";
                loginCard.style.display = "block";
                // Limpiar campos de login y mensaje de error
                usuarioInput.value = "";
                passwordInput.value = "";
                errorMsg.style.display = "none";
            }
        }

        /**
         * Verifica el estado de la sesi贸n almacenado en localStorage al cargar la p谩gina.
         */
        function checkLoginState() {
            // El estado de login ahora se verifica primariamente con la existencia del JWT
            const token = localStorage.getItem('jwtToken');
            displayUI(!!token);
        }

        /**
         * Maneja el proceso de inicio de sesi贸n.
         */
        async function login() {
            const user = usuarioInput.value.trim();
            const pass = passwordInput.value.trim();

            errorMsg.style.display = "none";

            if (!user || !pass) {
                errorMsg.textContent = "Por favor, ingrese usuario y contrase帽a.";
                errorMsg.style.display = "block";
                return;
            }

            try {
                // 锔 ADECUACIN: Usar la URL base + el endpoint de login
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: user, password: pass })
                });

                if (response.ok) {
                    const data = await response.json();
                    // 1. Guardar el token JWT
                    localStorage.setItem('jwtToken', data.token);
                    // 2. Marcar como logueado
                    localStorage.setItem('isLoggedIn', 'true');
                    displayUI(true);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Respuesta del servidor no v谩lida' }));
                    errorMsg.textContent = `Error: ${errorData.error || response.statusText}`;
                    errorMsg.style.display = "block";
                }
            } catch (error) {
                errorMsg.textContent = "No se pudo contactar al servidor para el login. Revise la URL de la API.";
                errorMsg.style.display = "block";
                console.error("Login error:", error);
            }
        }

        /**
         * Maneja el proceso de cierre de sesi贸n.
         * Elimina el estado de localStorage.
         */
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('jwtToken'); // 隆CRTICO! Eliminar el token
            displayUI(false);
        }

        // --- L贸gica del formulario de solicitud ---

        // 锔 ADECUACIN: Usar la URL base + el endpoint de generaci贸n
        const PYTHON_ENDPOINT = `${API_BASE_URL}/generate-word`; 
        const form = document.getElementById('solicitudForm');
        const responseMessage = document.getElementById('response-message');
        const submitButton = document.querySelector('.btn-submit');
        const servicioSelect = document.getElementById('servicio');
        const descHiddenInput = document.getElementById('descripcion_del_servicio');

        // Funci贸n para actualizar el campo oculto de descripci贸n al cambiar el servicio
        servicioSelect.addEventListener('change', () => {
            descHiddenInput.value = servicioSelect.value;
        });

        function showMessage(text, type) {
            responseMessage.textContent = text;
            // Estilos para los mensajes (success/error, puedes definirlos en el CSS)
            responseMessage.className = `message ${type}`; 
            responseMessage.style.display = 'block';
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            responseMessage.style.display = 'none';
            submitButton.disabled = true;
            submitButton.textContent = 'Procesando...';

            try {
                const formData = new FormData(form);

                // OBTENER EL TOKEN Y PREPARAR HEADERS
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    showMessage("Error de autenticaci贸n: Token JWT no encontrado. Inicie sesi贸n de nuevo.", 'error');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Generar Solicitud y Descargar Word';
                    return;
                }

                // 锔 CRTICO: El fetch DEBE incluir el token en el header de Authorization
                const response = await fetch(PYTHON_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        // Importante: No se usa 'Content-Type': 'application/json' con FormData
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = "Documentos_Generados.zip";

                    if (contentDisposition && contentDisposition.includes("filename=")) {
                        const match = contentDisposition.match(/filename="(.+?)"/);
                        if (match) filename = match[1];
                    }

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a); // Limpiar el elemento 
                    window.URL.revokeObjectURL(url);

                    // Mensaje de 茅xito de la descarga.
                    showMessage(`Documento generado y DESCARGADO: ${filename}.`, 'success');

                } else if (response.status === 401) {
                    // Manejo de error de token expirado/inv谩lido
                    showMessage("Sesi贸n expirada o no autorizada. Inicie sesi贸n de nuevo.", 'error');
                    logout(); // Forzar cierre de sesi贸n
                } else {
                    const errorData = await response.json().catch(() => ({ error: `Error HTTP ${response.status}` }));
                    showMessage(`Error: ${errorData.error || response.statusText}`, 'error');
                }

            }
            catch (error) {
                console.error("Error en el env铆o del formulario:", error);
                showMessage("No se pudo contactar al servidor Python. Revise la URL de la API.", "error");
            }

            submitButton.disabled = false;
            submitButton.textContent = 'Generar Solicitud y Descargar Word';
        });

        //  Inicializar la verificaci贸n del estado de login al cargar la p谩gina
        checkLoginState();
    </script>

</body>

</html>